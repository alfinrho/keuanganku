<!DOCTYPE html>
<html lang="id" class="h-full bg-gray-100">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Pencatat Keuangan Pribadi</title>
    <!-- Memuat Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Memuat Chart.js -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <!-- Font Awesome untuk Ikon -->
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    
    <!-- Library untuk PDF & Excel -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>

    <!-- Memuat Supabase Client -->
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap');
        html { font-family: 'Inter', sans-serif; scroll-behavior: smooth; }
        ::-webkit-scrollbar { width: 8px; height: 8px; }
        ::-webkit-scrollbar-track { background: #f1f1f1; border-radius: 10px; }
        ::-webkit-scrollbar-thumb { background: #c0c0c0; border-radius: 10px; }
        ::-webkit-scrollbar-thumb:hover { background: #a8a8a8; }
        input[type='number']::-webkit-outer-spin-button, input[type='number']::-webkit-inner-spin-button { -webkit-appearance: none; margin: 0; }
        input[type='number'] { -moz-appearance: textfield; }
        
        /* CSS PDF */
        body.is-printing-pdf .printable-area { font-size: 10px; }
        body.is-printing-pdf .printable-area h2 { font-size: 1.25rem; line-height: 1.75rem; }
        body.is-printing-pdf .printable-area h3 { font-size: 1rem; line-height: 1.5rem; }
        body.is-printing-pdf .printable-area th, body.is-printing-pdf .printable-area td { padding: 4px 6px !important; font-size: 8px !important; }
        body.is-printing-pdf .no-print { display: none !important; }
        body.is-printing-pdf .printable-area h2.pdf-hidden { display: none !important; }
        body.is-printing-pdf .printable-area h2.pdf-visible { display: block !important; }

        #demo-banner { background-color: #FFF7ED; color: #C05621; border-bottom: 1px solid #FED7D7; padding: 0.5rem; text-align: center; font-size: 0.875rem; font-weight: 500; }
    </style>
</head>

<body class="h-full bg-gray-100">
    <div id="modal-backdrop" class="fixed inset-0 bg-black bg-opacity-50 z-40 hidden no-print"></div>

    <!-- Overlay Login -->
    <div id="login-overlay" class="fixed inset-0 z-50 flex items-center justify-center bg-gray-100 p-4 no-print">
        <div class="w-full max-w-sm p-8 bg-white rounded-2xl shadow-xl">
            <h2 class="text-3xl font-bold text-center text-gray-800">Hai Alfin Rho</h2>
            <p class="mt-2 text-center text-gray-500">Masukkan password untuk akses</p>
            <form id="login-form" class="mt-8 space-y-6">
                <div>
                    <input id="password" name="password" type="password" required class="w-full px-4 py-3 rounded-lg border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500" placeholder="Password">
                </div>
                <p id="login-error" class="text-sm text-red-600 text-center hidden">Password salah.</p>
                <button type="submit" class="w-full py-3 px-4 rounded-lg text-white font-semibold bg-blue-600 hover:bg-blue-700 transition-colors">Login</button>
            </form>
        </div>
    </div>

    <!-- Main App -->
    <div id="main-app-content" class="hidden h-full flex flex-col">
        <div id="demo-banner" class="hidden no-print">Mode Demo: Cek koneksi Supabase Anda.</div>

        <header class="bg-white shadow-md w-full p-4 flex justify-between items-center z-10 sticky top-0 no-print">
            <div class="flex items-baseline space-x-6">
                <h1 class="text-2xl font-bold text-blue-700">Keuanganku</h1>
                <nav>
                    <ul class="flex space-x-1">
                        <li><a href="#" data-view="view-beranda" class="nav-link px-4 py-2 rounded-lg font-medium text-sm hover:bg-gray-100">Beranda</a></li>
                        <li><a href="#" data-view="view-laporan-bulanan" class="nav-link px-4 py-2 rounded-lg font-medium text-sm hover:bg-gray-100">Laporan Bulanan</a></li>
                        <li><a href="#" data-view="view-laporan-tahunan" class="nav-link px-4 py-2 rounded-lg font-medium text-sm hover:bg-gray-100">Laporan Tahunan</a></li>
                        <li><a href="#" data-view="view-transaksi-anomali" class="nav-link px-4 py-2 rounded-lg font-medium text-sm hover:bg-gray-100">Anomali</a></li>
                        <li><a href="#" data-view="view-master-setting" class="nav-link px-4 py-2 rounded-lg font-medium text-sm hover:bg-gray-100">Master Setting</a></li>
                    </ul>
                </nav>
            </div>
            <span id="user-id-display" class="text-xs text-gray-400 truncate" title="User ID"></span>
        </header>

        <main class="flex-1 overflow-y-auto p-8">
            <!-- View: Beranda -->
            <div id="view-beranda" class="view-content grid grid-cols-1 lg:grid-cols-3 gap-8">
                <div class="lg:col-span-2 space-y-8">
                    <!-- Summary Cards -->
                    <div class="bg-white p-6 rounded-2xl shadow-lg">
                        <h2 class="text-xl font-semibold mb-5">Summary (Bulan Ini)</h2>
                        <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
                            <div class="bg-green-50 p-5 rounded-xl border border-green-200">
                                <div class="text-sm font-medium text-green-600">Pemasukan (Aktual)</div>
                                <div id="summary-income" class="text-2xl font-bold text-green-800 mt-1">IDR 0</div>
                            </div>
                            <div class="bg-red-50 p-5 rounded-xl border border-red-200">
                                <div class="text-sm font-medium text-red-600">Pengeluaran</div>
                                <div id="summary-expense" class="text-2xl font-bold text-red-800 mt-1">IDR 0</div>
                            </div>
                            <div class="bg-blue-50 p-5 rounded-xl border border-blue-200">
                                <div class="text-sm font-medium text-blue-600">Saldo Akhir</div>
                                <div id="summary-balance" class="text-2xl font-bold text-blue-800 mt-1">IDR 0</div>
                            </div>
                        </div>
                        <div class="mt-4 p-4 bg-yellow-50 border border-yellow-200 rounded-xl flex justify-between items-center">
                            <span class="text-sm font-medium text-yellow-800"><i class="fas fa-history mr-2"></i>Sisa Saldo Bulan Lalu:</span>
                            <span id="summary-prev-balance" class="text-lg font-bold text-yellow-800">IDR 0</span>
                        </div>
                    </div>

                    <!-- Transaction List -->
                    <div class="bg-white p-6 rounded-2xl shadow-lg">
                        <div class="flex justify-between items-center mb-5">
                            <h2 class="text-xl font-semibold">Riwayat Transaksi (Bulan Ini)</h2>
                            <button id="open-excel-modal" class="flex items-center space-x-2 py-2 px-4 rounded-lg text-white text-sm font-semibold bg-green-600 hover:bg-green-700 transition-colors no-print">
                                <i class="fas fa-file-excel"></i> <span>Download Excel</span>
                            </button>
                        </div>
                        <div class="overflow-x-auto">
                            <table class="min-w-full divide-y divide-gray-200">
                                <thead class="bg-gray-50">
                                    <tr>
                                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Tanggal</th>
                                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Kategori</th>
                                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Keterangan</th>
                                        <th class="px-6 py-3 text-right text-xs font-medium text-gray-500 uppercase">Jumlah</th>
                                        <th class="px-6 py-3 text-center text-xs font-medium text-gray-500 uppercase w-20">Aksi</th>
                                    </tr>
                                </thead>
                                <tbody id="transaction-list" class="bg-white divide-y divide-gray-200"></tbody>
                            </table>
                        </div>
                    </div>
                </div>

                <!-- Form Tambah Transaksi -->
                <div class="lg:col-span-1">
                    <div class="bg-white p-6 rounded-2xl shadow-lg sticky top-24 no-print">
                        <div class="bg-gray-50 p-5 rounded-xl border border-gray-200">
                            <h2 class="text-lg font-semibold text-gray-800 mb-4">Tambah Transaksi</h2>
                            <form id="transaction-form" class="space-y-4">
                                <input type="hidden" id="tx-id"> <!-- Hidden ID for edit mode -->
                                <div>
                                    <label class="block text-sm font-medium text-gray-700">Tanggal</label>
                                    <input type="date" id="date" required class="mt-1 block w-full rounded-lg border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500">
                                </div>
                                <div>
                                    <label class="block text-sm font-medium text-gray-700">Jenis</label>
                                    <select id="type" required class="mt-1 block w-full rounded-lg border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500">
                                        <option value="pengeluaran">Pengeluaran</option>
                                        <option value="pemasukan">Pemasukan</option>
                                    </select>
                                </div>
                                <div>
                                    <label class="block text-sm font-medium text-gray-700">Kategori</label>
                                    <select id="category" required class="mt-1 block w-full rounded-lg border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500" disabled>
                                        <option value="">Pilih jenis dulu...</option>
                                    </select>
                                </div>
                                <div>
                                    <label class="block text-sm font-medium text-gray-700">Jumlah (IDR)</label>
                                    <input type="number" id="amount" required min="0" placeholder="50000" class="mt-1 block w-full rounded-lg border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500">
                                </div>
                                <div>
                                    <label class="block text-sm font-medium text-gray-700">Keterangan</label>
                                    <textarea id="description" rows="2" placeholder="Cth: Kopi susu" class="mt-1 block w-full rounded-lg border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500"></textarea>
                                </div>
                                
                                <!-- Checkbox Transaksi Berulang -->
                                <div class="flex items-center" id="recurring-container">
                                    <input id="is-recurring" type="checkbox" class="h-4 w-4 text-blue-600 focus:ring-blue-500 border-gray-300 rounded">
                                    <label for="is-recurring" class="ml-2 block text-sm text-gray-900">
                                        Transaksi Berulang (Tiap Bulan)
                                    </label>
                                </div>

                                <div class="flex gap-2">
                                    <button type="submit" id="btn-save-tx" class="flex-1 py-3 px-4 rounded-lg text-white font-semibold bg-blue-600 hover:bg-blue-700 transition-colors">Simpan</button>
                                    <button type="button" id="btn-cancel-edit" class="hidden px-4 py-3 rounded-lg text-gray-700 bg-gray-200 hover:bg-gray-300 transition-colors">Batal</button>
                                </div>
                                <p id="form-status" class="text-sm text-green-600 text-center mt-2"></p>
                            </form>
                        </div>
                    </div>
                </div>
            </div>

            <!-- View: Laporan Bulanan (Kode sama, disederhanakan untuk hemat space) -->
            <div id="view-laporan-bulanan" class="view-content hidden space-y-6">
                <div class="bg-white p-6 rounded-2xl shadow-lg printable-area">
                    <div class="flex justify-between items-center mb-4 no-print">
                        <h2 class="text-2xl font-bold pdf-hidden">Laporan Bulanan</h2>
                        <button id="download-monthly-pdf" class="flex items-center space-x-2 py-2 px-4 rounded-lg text-white text-sm font-semibold bg-red-600 hover:bg-red-700 transition-colors">
                            <i class="fas fa-file-pdf"></i> <span>Download PDF</span>
                        </button>
                    </div>
                    <h2 class="text-2xl font-bold mb-4 hidden pdf-visible">Laporan Bulanan</h2>
                    <div class="flex space-x-4 mb-6 pb-6 border-b border-gray-200 no-print">
                        <div><label class="block text-sm font-medium text-gray-700">Bulan</label><select id="monthly-report-month" class="mt-1 block w-full rounded-lg border-gray-300 shadow-sm"></select></div>
                        <div><label class="block text-sm font-medium text-gray-700">Tahun</label><select id="monthly-report-year" class="mt-1 block w-full rounded-lg border-gray-300 shadow-sm"></select></div>
                    </div>
                    <div id="monthly-report-info-pdf" class="mb-4 hidden pdf-visible"></div>
                    <div class="grid grid-cols-1 md:grid-cols-3 gap-6 mb-6">
                        <div class="bg-green-50 p-5 rounded-xl border border-green-200"><div class="text-sm font-medium text-green-600">Total Pemasukan</div><div id="monthly-report-income" class="text-2xl font-bold text-green-800 mt-1">IDR 0</div></div>
                        <div class="bg-red-50 p-5 rounded-xl border border-red-200"><div class="text-sm font-medium text-red-600">Total Pengeluaran</div><div id="monthly-report-expense" class="text-2xl font-bold text-red-800 mt-1">IDR 0</div></div>
                        <div class="bg-blue-50 p-5 rounded-xl border border-blue-200"><div class="text-sm font-medium text-blue-600">Saldo Akhir</div><div id="monthly-report-cashflow" class="text-2xl font-bold text-blue-800 mt-1">IDR 0</div></div>
                    </div>
                    <div class="grid grid-cols-1 lg:grid-cols-3 gap-6 mb-6">
                        <div class="lg:col-span-1 p-5 rounded-xl border border-gray-200"><h3 class="text-lg font-semibold mb-3">Arus Kas</h3><canvas id="monthly-cashflow-chart"></canvas></div>
                        <div class="lg:col-span-1 p-5 rounded-xl border border-gray-200"><h3 class="text-lg font-semibold mb-3">Pemasukan</h3><canvas id="monthly-income-chart"></canvas></div>
                        <div class="lg:col-span-1 p-5 rounded-xl border border-gray-200"><h3 class="text-lg font-semibold mb-3">Pengeluaran</h3><canvas id="monthly-expense-chart"></canvas></div>
                    </div>
                    <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
                        <div><h3 class="text-lg font-semibold mb-3 text-green-700">Rincian Pemasukan</h3><div id="monthly-income-table" class="max-h-96 overflow-y-auto"></div></div>
                        <div><h3 class="text-lg font-semibold mb-3 text-red-700">Rincian Pengeluaran</h3><div id="monthly-expense-table" class="max-h-96 overflow-y-auto"></div></div>
                    </div>
                </div>
            </div>

            <!-- View: Laporan Tahunan & Anomali (Placeholder konten sama) -->
            <div id="view-laporan-tahunan" class="view-content hidden"><div class="bg-white p-6 rounded-2xl shadow-lg printable-area"><div class="flex justify-between items-center mb-4 no-print"><h2 class="text-2xl font-bold pdf-hidden">Laporan Tahunan</h2><button id="download-annual-pdf" class="flex items-center space-x-2 py-2 px-4 rounded-lg text-white text-sm font-semibold bg-red-600 hover:bg-red-700 transition-colors"><i class="fas fa-file-pdf"></i> <span>Download PDF</span></button></div><h2 class="text-2xl font-bold mb-4 hidden pdf-visible">Laporan Tahunan</h2><div class="flex space-x-4 mb-6 pb-6 border-b border-gray-200 no-print"><div><label class="block text-sm font-medium text-gray-700">Mulai Bulan</label><select id="annual-report-month" class="mt-1 block w-full rounded-lg border-gray-300 shadow-sm"></select></div><div><label class="block text-sm font-medium text-gray-700">Mulai Tahun</label><select id="annual-report-year" class="mt-1 block w-full rounded-lg border-gray-300 shadow-sm"></select></div></div><div id="annual-report-info-pdf" class="mb-4 hidden pdf-visible"></div><div class="grid grid-cols-1 lg:grid-cols-2 gap-6 mb-6"><div class="p-5 rounded-xl border border-gray-200"><h3 class="text-lg font-semibold mb-3 text-center">Pemasukan 12 Bulan</h3><canvas id="annual-income-chart" height="200"></canvas></div><div class="p-5 rounded-xl border border-gray-200"><h3 class="text-lg font-semibold mb-3 text-center">Pengeluaran 12 Bulan</h3><canvas id="annual-expense-chart" height="200"></canvas></div></div><div class="p-5 rounded-xl border border-gray-200 mb-8"><h3 class="text-lg font-semibold mb-3 text-center">Arus Kas 12 Bulan</h3><canvas id="annual-cashflow-chart" height="150"></canvas></div><div class="space-y-8"><div><h3 class="text-xl font-semibold mb-3 text-blue-700">Overview</h3><div class="overflow-x-auto shadow rounded-lg"><table class="min-w-full divide-y divide-gray-200"><thead class="bg-blue-600 text-white"><tr id="annual-overview-header"></tr></thead><tbody id="annual-overview-body" class="bg-white divide-y divide-gray-200"></tbody></table></div></div></div></div></div>
            <div id="view-transaksi-anomali" class="view-content hidden"><div class="bg-white p-6 rounded-2xl shadow-lg"><h2 class="text-2xl font-bold mb-4">Deteksi Transaksi Anomali</h2><p class="text-gray-600 mb-6 pb-6 border-b border-gray-200">Menampilkan transaksi pengeluaran > 3x rata-rata.</p><div class="overflow-x-auto"><table class="min-w-full divide-y divide-gray-200"><thead class="bg-gray-50"><tr><th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Tanggal</th><th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Kategori</th><th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Keterangan</th><th class="px-6 py-3 text-right text-xs font-medium text-gray-500 uppercase">Jumlah</th><th class="px-6 py-3 text-right text-xs font-medium text-gray-500 uppercase">Rata-rata</th></tr></thead><tbody id="anomaly-list" class="bg-white divide-y divide-gray-200"></tbody></table></div></div></div>

            <!-- View: Master Setting (Updated) -->
            <div id="view-master-setting" class="view-content hidden space-y-8">
                <!-- Kategori -->
                <div class="bg-white p-6 rounded-2xl shadow-lg">
                    <div class="flex justify-between items-center mb-6 no-print">
                        <h2 class="text-2xl font-bold">Master Kategori</h2>
                        <button id="add-category-btn" class="py-2 px-4 rounded-lg text-white font-semibold bg-blue-600 hover:bg-blue-700 transition-colors">+ Tambah Kategori</button>
                    </div>
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-8">
                        <div><h3 class="text-lg font-semibold text-green-700 mb-3 pb-3 border-b border-gray-200">Kategori Pemasukan</h3><ul id="master-pemasukan-list" class="divide-y divide-gray-200"></ul></div>
                        <div><h3 class="text-lg font-semibold text-red-700 mb-3 pb-3 border-b border-gray-200">Kategori Pengeluaran</h3><ul id="master-pengeluaran-list" class="divide-y divide-gray-200"></ul></div>
                    </div>
                </div>
                
                <!-- Transaksi Berulang -->
                <div class="bg-white p-6 rounded-2xl shadow-lg">
                    <h2 class="text-2xl font-bold mb-4">Master Transaksi Berulang</h2>
                    <p class="text-sm text-gray-500 mb-4">Transaksi ini akan otomatis dibuat setiap bulan pada tanggal yang ditentukan.</p>
                    <div class="overflow-x-auto">
                        <table class="min-w-full divide-y divide-gray-200">
                            <thead class="bg-gray-50">
                                <tr>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Tgl</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Jenis</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Kategori</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Ket</th>
                                    <th class="px-6 py-3 text-right text-xs font-medium text-gray-500 uppercase">Jumlah</th>
                                    <th class="px-6 py-3 text-center text-xs font-medium text-gray-500 uppercase">Aksi</th>
                                </tr>
                            </thead>
                            <tbody id="recurring-list" class="bg-white divide-y divide-gray-200">
                                <tr><td colspan="6" class="px-6 py-4 text-center text-gray-500 italic">Memuat data...</td></tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </main>
    </div>

    <!-- Modals -->
    <div id="status-modal" class="fixed bottom-5 right-5 z-50 bg-gray-800 text-white py-3 px-5 rounded-lg shadow-xl transition-all translate-y-16 opacity-0 hidden no-print"><p id="status-message"></p></div>
    <div id="category-modal" class="fixed inset-0 z-50 flex items-center justify-center p-4 hidden no-print"><div class="w-full max-w-md bg-white rounded-2xl shadow-xl p-6"><h3 id="category-modal-title" class="text-xl font-semibold mb-6">Tambah Kategori Baru</h3><form id="category-modal-form"><input type="hidden" id="category-modal-id"><div class="space-y-4"><div><label class="block text-sm font-medium text-gray-700">Nama</label><input type="text" id="category-modal-name" required class="mt-1 block w-full rounded-lg border-gray-300 shadow-sm"></div><div><label class="block text-sm font-medium text-gray-700">Jenis</label><select id="category-modal-type" required class="mt-1 block w-full rounded-lg border-gray-300 shadow-sm"><option value="pemasukan">Pemasukan</option><option value="pengeluaran">Pengeluaran</option></select></div></div><div class="flex justify-end space-x-3 mt-8"><button type="button" id="category-modal-cancel" class="py-2 px-4 rounded-lg text-gray-700 bg-gray-100 hover:bg-gray-200 font-medium">Batal</button><button type="submit" class="py-2 px-4 rounded-lg text-white bg-blue-600 hover:bg-blue-700 font-medium">Simpan</button></div></form></div></div>
    <div id="excel-download-modal" class="fixed inset-0 z-50 flex items-center justify-center p-4 hidden no-print"><div class="w-full max-w-md bg-white rounded-2xl shadow-xl p-6"><h3 class="text-xl font-semibold mb-6">Download Riwayat</h3><div class="space-y-4"><div><label class="block text-sm font-medium text-gray-700">Bulan</label><select id="excel-month-select" class="mt-1 block w-full rounded-lg border-gray-300 shadow-sm"></select></div><div><label class="block text-sm font-medium text-gray-700">Tahun</label><select id="excel-year-select" class="mt-1 block w-full rounded-lg border-gray-300 shadow-sm"></select></div></div><div class="flex justify-end space-x-3 mt-8"><button type="button" id="excel-download-cancel" class="py-2 px-4 rounded-lg text-gray-700 bg-gray-100 hover:bg-gray-200 font-medium">Batal</button><button type="button" id="download-excel-confirm" class="py-2 px-4 rounded-lg text-white bg-green-600 hover:bg-green-700 font-medium">Download</button></div></div></div>
    <div id="delete-modal" class="fixed inset-0 z-50 flex items-center justify-center p-4 hidden no-print"><div class="w-full max-w-md bg-white rounded-2xl shadow-xl p-6"><h3 class="text-xl font-semibold mb-4">Hapus Data?</h3><p class="text-gray-600 mb-4">Data yang dihapus tidak dapat dikembalikan.</p><div class="flex justify-end space-x-3 mt-6"><button type="button" id="delete-modal-cancel" class="py-2 px-4 rounded-lg text-gray-700 bg-gray-100 hover:bg-gray-200 font-medium">Batal</button><button type="button" id="delete-modal-confirm" class="py-2 px-4 rounded-lg text-white bg-red-600 hover:bg-red-700 font-medium">Hapus</button></div></div></div>

    <!-- SCRIPT -->
    <script type="module">
        const SUPABASE_URL = 'https://azgkrncmbalimhwickmm.supabase.co';
        const SUPABASE_KEY = 'sb_publishable_0JKn3axQn0QEqSGsgtCg1Q_Bi-QCYM2';

        const { jsPDF } = window.jspdf;
        const { createClient } = supabase;
        const db = createClient(SUPABASE_URL, SUPABASE_KEY, { auth: { persistSession: true } });

        let userId; 
        let categoriesData = { pemasukan: [], pengeluaran: [] };
        let allTransactions = []; 
        let charts = {}; 
        let deleteTarget = null; // { type: 'transaction'|'category'|'recurring', id: 1 }
        const MONTH_NAMES = ["Januari", "Februari", "Maret", "April", "Mei", "Juni", "Juli", "Agustus", "September", "Oktober", "November", "Desember"];

        // DOM Elements
        const loginOverlay = document.getElementById('login-overlay');
        const formStatus = document.getElementById('form-status');
        const transactionForm = document.getElementById('transaction-form');
        const recurringContainer = document.getElementById('recurring-container');
        const isRecurringInput = document.getElementById('is-recurring');
        const transactionList = document.getElementById('transaction-list');
        const recurringList = document.getElementById('recurring-list');
        const txIdInput = document.getElementById('tx-id');
        const btnSaveTx = document.getElementById('btn-save-tx');
        const btnCancelEdit = document.getElementById('btn-cancel-edit');

        // UTILS
        function formatCurrency(amount) { return new Intl.NumberFormat('id-ID', { style: 'currency', currency: 'IDR', minimumFractionDigits: 0 }).format(amount); }
        function showStatus(msg, isError = false) {
            const el = document.getElementById('status-modal');
            document.getElementById('status-message').textContent = msg;
            el.classList.remove('hidden', 'bg-gray-800', 'bg-red-600', 'translate-y-16', 'opacity-0');
            el.classList.add(isError ? 'bg-red-600' : 'bg-gray-800', 'translate-y-0', 'opacity-100');
            setTimeout(() => { el.classList.add('translate-y-16', 'opacity-0'); setTimeout(() => el.classList.add('hidden'), 300); }, 3000);
        }
        function showModal(id) { document.getElementById('modal-backdrop').classList.remove('hidden'); document.getElementById(id).classList.remove('hidden'); }
        function hideModal(id) { document.getElementById('modal-backdrop').classList.add('hidden'); document.getElementById(id).classList.add('hidden'); }

        // DATA LOADERS
        async function loadData() {
            await Promise.all([loadCategories(), loadTransactions(), loadRecurring()]);
            renderDashboard();
            checkAndGenerateRecurring(); // Check auto-generate on load
        }

        async function loadCategories() {
            const { data } = await db.from('categories').select('*').eq('user_id', userId);
            categoriesData.pemasukan = data.filter(c => c.type === 'pemasukan');
            categoriesData.pengeluaran = data.filter(c => c.type === 'pengeluaran');
            if(data.length === 0) await initDefaultCategories();
            updateCategoryOptions();
            renderMasterSettings();
        }

        async function loadTransactions() {
            const { data } = await db.from('transactions').select('*').eq('user_id', userId);
            allTransactions = data || [];
        }

        async function loadRecurring() {
            const { data } = await db.from('recurring_transactions').select('*').eq('user_id', userId);
            renderRecurringList(data || []);
        }

        async function initDefaultCategories() {
            const defaults = [{name:"Gaji",type:"pemasukan",user_id:userId},{name:"Makan",type:"pengeluaran",user_id:userId}];
            await db.from('categories').insert(defaults);
            await loadCategories();
        }

        // RECURRING LOGIC
        async function checkAndGenerateRecurring() {
            const { data: rules } = await db.from('recurring_transactions').select('*').eq('user_id', userId);
            if (!rules || rules.length === 0) return;

            const now = new Date();
            const currentMonth = now.getMonth();
            const currentYear = now.getFullYear();
            const todayDate = now.getDate();
            
            let newTransactions = [];
            let rulesToUpdate = [];

            for (const rule of rules) {
                let lastGenDate = rule.last_generated ? new Date(rule.last_generated) : null;
                
                // Cek apakah sudah digenerate bulan ini
                const alreadyGeneratedThisMonth = lastGenDate && 
                                                  lastGenDate.getMonth() === currentMonth && 
                                                  lastGenDate.getFullYear() === currentYear;

                // Jika belum generate bulan ini DAN tanggal hari ini >= tanggal jadwal
                if (!alreadyGeneratedThisMonth && todayDate >= rule.day_of_month) {
                    // Buat transaksi baru
                    newTransactions.push({
                        date: new Date().toISOString().split('T')[0], // Set to today
                        type: rule.type,
                        category: rule.category,
                        amount: rule.amount,
                        description: rule.description + " (Transaksi Berulang)",
                        user_id: userId
                    });
                    // Update last_generated rule
                    rulesToUpdate.push(rule.id);
                }
            }

            if (newTransactions.length > 0) {
                await db.from('transactions').insert(newTransactions);
                // Update last_generated date to NOW for processed rules
                const todayStr = new Date().toISOString().split('T')[0];
                for (const id of rulesToUpdate) {
                    await db.from('recurring_transactions').update({ last_generated: todayStr }).eq('id', id);
                }
                await loadTransactions();
                renderDashboard();
                showStatus(`${newTransactions.length} Transaksi berulang otomatis ditambahkan.`);
            }
        }

        // RENDERERS
        function renderDashboard() {
            const now = new Date();
            // Calculate Opening Balance
            const cutoffDate = new Date(now.getFullYear(), now.getMonth(), 1);
            let openingBalance = 0;
            allTransactions.forEach(tx => {
                if (new Date(tx.date) < cutoffDate) openingBalance += (tx.type === 'pemasukan' ? tx.amount : -tx.amount);
            });

            // Filter Current Month
            let inc = 0, exp = 0;
            const curMonthTx = allTransactions.filter(t => {
                const d = new Date(t.date);
                return d.getMonth() === now.getMonth() && d.getFullYear() === now.getFullYear();
            }).sort((a,b) => new Date(b.date) - new Date(a.date));

            transactionList.innerHTML = '';
            
            // Opening Balance Row
            if (openingBalance !== 0) {
                const rowClass = openingBalance >= 0 ? 'bg-yellow-50' : 'bg-red-50';
                const colClass = openingBalance >= 0 ? 'text-yellow-700' : 'text-red-700';
                transactionList.innerHTML += `<tr class="${rowClass} font-semibold border-b border-yellow-200"><td class="px-6 py-3 text-xs text-gray-500">1 ${MONTH_NAMES[now.getMonth()]}</td><td class="px-6 py-3 text-gray-700">Pemasukan Sisa Saldo</td><td class="px-6 py-3 italic text-gray-500">Otomatis bulan lalu</td><td class="px-6 py-3 text-right ${colClass}">${formatCurrency(openingBalance)}</td><td></td></tr>`;
            }

            // Transactions
            if (curMonthTx.length === 0 && openingBalance === 0) {
                transactionList.innerHTML = `<tr><td colspan="5" class="px-6 py-8 text-center text-gray-400 italic">Belum ada transaksi bulan ini.</td></tr>`;
            } else {
                curMonthTx.forEach(t => {
                    if(t.type === 'pemasukan') inc += t.amount; else exp += t.amount;
                    transactionList.innerHTML += `
                        <tr class="${t.type === 'pemasukan' ? 'bg-green-50' : 'bg-red-50'} border-b border-gray-100 hover:bg-gray-50 transition">
                            <td class="px-6 py-3 text-sm text-gray-600">${new Date(t.date).toLocaleDateString('id-ID')}</td>
                            <td class="px-6 py-3 text-sm font-medium text-gray-800">${t.category}</td>
                            <td class="px-6 py-3 text-sm text-gray-500 truncate max-w-xs">${t.description || '-'}</td>
                            <td class="px-6 py-3 text-right font-bold text-sm ${t.type === 'pemasukan' ? 'text-green-600' : 'text-red-600'}">${formatCurrency(t.amount)}</td>
                            <td class="px-6 py-3 text-center">
                                <button onclick="window.editTransaction(${t.id})" class="text-blue-500 hover:text-blue-700 mr-2" title="Edit"><i class="fas fa-pen"></i></button>
                                <button onclick="window.confirmDelete('transaction', ${t.id})" class="text-red-500 hover:text-red-700" title="Hapus"><i class="fas fa-trash"></i></button>
                            </td>
                        </tr>`;
                });
            }

            document.getElementById('summary-income').textContent = formatCurrency(inc);
            document.getElementById('summary-expense').textContent = formatCurrency(exp);
            document.getElementById('summary-prev-balance').textContent = formatCurrency(openingBalance);
            document.getElementById('summary-balance').textContent = formatCurrency(openingBalance + inc - exp);
        }

        function renderRecurringList(data) {
            recurringList.innerHTML = '';
            if (data.length === 0) {
                recurringList.innerHTML = `<tr><td colspan="6" class="px-6 py-4 text-center text-gray-500 italic">Belum ada transaksi berulang.</td></tr>`;
                return;
            }
            data.forEach(r => {
                recurringList.innerHTML += `
                    <tr class="bg-white border-b border-gray-100 hover:bg-gray-50">
                        <td class="px-6 py-3 text-sm text-gray-600">Tgl ${r.day_of_month}</td>
                        <td class="px-6 py-3 text-sm text-gray-800 uppercase">${r.type}</td>
                        <td class="px-6 py-3 text-sm text-gray-800">${r.category}</td>
                        <td class="px-6 py-3 text-sm text-gray-500">${r.description || '-'}</td>
                        <td class="px-6 py-3 text-right text-sm font-bold">${formatCurrency(r.amount)}</td>
                        <td class="px-6 py-3 text-center">
                             <button onclick="window.confirmDelete('recurring', ${r.id})" class="text-red-500 hover:text-red-700"><i class="fas fa-trash"></i></button>
                        </td>
                    </tr>
                `;
            });
        }

        function renderMasterSettings() {
            const pList = document.getElementById('master-pemasukan-list');
            const kList = document.getElementById('master-pengeluaran-list');
            pList.innerHTML = ''; kList.innerHTML = '';
            
            const render = (arr, el) => {
                arr.forEach(c => {
                    el.innerHTML += `<li class="flex justify-between py-2 items-center">
                        <span>${c.name}</span>
                        <div class="flex gap-2">
                            <button onclick="window.openCategoryModal('edit', ${c.id})" class="text-blue-500 text-sm">Edit</button>
                            <button onclick="window.confirmDelete('category', ${c.id})" class="text-red-500 text-sm">Hapus</button>
                        </div>
                    </li>`;
                });
            };
            render(categoriesData.pemasukan, pList);
            render(categoriesData.pengeluaran, kList);
        }
        
        function updateCategoryOptions() {
            const type = document.getElementById('type').value;
            const catSelect = document.getElementById('category');
            catSelect.innerHTML = '';
            const cats = categoriesData[type] || [];
            cats.forEach(c => {
                const opt = document.createElement('option');
                opt.value = c.name;
                opt.textContent = c.name;
                catSelect.appendChild(opt);
            });
            catSelect.disabled = cats.length === 0;
        }

        // ACTIONS
        window.editTransaction = (id) => {
            const tx = allTransactions.find(t => t.id === id);
            if (!tx) return;
            
            document.getElementById('date').value = tx.date;
            document.getElementById('type').value = tx.type;
            updateCategoryOptions(); // Refresh category list based on type
            document.getElementById('category').value = tx.category;
            document.getElementById('amount').value = tx.amount;
            document.getElementById('description').value = tx.description || '';
            
            // Setup Form for Edit
            txIdInput.value = id;
            btnSaveTx.textContent = "Update Transaksi";
            btnSaveTx.classList.replace('bg-blue-600', 'bg-yellow-600');
            btnSaveTx.classList.replace('hover:bg-blue-700', 'hover:bg-yellow-700');
            btnCancelEdit.classList.remove('hidden');
            
            // Hide recurring checkbox in edit mode (complexity reduction)
            recurringContainer.classList.add('hidden');
            
            // Scroll to form
            transactionForm.scrollIntoView({ behavior: 'smooth' });
        };

        window.cancelEdit = () => {
            transactionForm.reset();
            document.getElementById('date').valueAsDate = new Date();
            txIdInput.value = '';
            btnSaveTx.textContent = "Simpan";
            btnSaveTx.classList.replace('bg-yellow-600', 'bg-blue-600');
            btnSaveTx.classList.replace('hover:bg-yellow-700', 'hover:bg-blue-700');
            btnCancelEdit.classList.add('hidden');
            recurringContainer.classList.remove('hidden');
            updateCategoryOptions();
        };

        window.confirmDelete = (type, id) => {
            deleteTarget = { type, id };
            showModal('delete-modal');
        };
        
        window.openCategoryModal = (mode, id) => {
            document.getElementById('category-modal-form').reset();
            document.getElementById('category-modal-id').value = id ? id : "";
            if(mode === 'edit') {
                const c = [...categoriesData.pemasukan, ...categoriesData.pengeluaran].find(x => x.id == id);
                if(c) { 
                    document.getElementById('category-modal-name').value = c.name; 
                    document.getElementById('category-modal-type').value = c.type; 
                }
            }
            showModal('category-modal');
        };

        // EVENT LISTENERS
        document.getElementById('login-form').addEventListener('submit', async (e) => {
            e.preventDefault();
            if(document.getElementById('password').value === 'alfinrho$') {
                loginOverlay.classList.add('hidden');
                document.getElementById('main-app-content').classList.remove('hidden');
                
                // Auth Flow
                let { data: { user } } = await db.auth.getUser();
                if (!user) {
                    const { data: up } = await db.auth.signUp({ email: `user${Date.now()}@demo.com`, password: 'password123' });
                    user = up.user;
                }
                userId = user?.id;
                document.getElementById('user-id-display').textContent = "ID: " + userId;
                
                await loadData();
                // Init charts/filters (omitted for brevity, assumes standard setup)
            } else {
                document.getElementById('login-error').classList.remove('hidden');
            }
        });

        transactionForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            if(!userId) return alert("Sesi habis.");
            
            const id = txIdInput.value;
            const dateVal = document.getElementById('date').value;
            const type = document.getElementById('type').value;
            const category = document.getElementById('category').value;
            const amount = document.getElementById('amount').value;
            const description = document.getElementById('description').value;
            const isRecurring = isRecurringInput.checked;

            btnSaveTx.textContent = "Proses..."; btnSaveTx.disabled = true;

            try {
                const payload = { date: dateVal, type, category, amount, description, user_id: userId };
                
                if (id) {
                    // UPDATE
                    await db.from('transactions').update(payload).eq('id', id);
                    showStatus("Transaksi diperbarui");
                    window.cancelEdit();
                } else {
                    // INSERT NEW
                    await db.from('transactions').insert([payload]);
                    showStatus("Transaksi disimpan");
                    
                    // Handle Recurring
                    if (isRecurring) {
                        const day = new Date(dateVal).getDate();
                        const rulePayload = { 
                            day_of_month: day, 
                            type, category, amount, description, user_id: userId,
                            last_generated: dateVal // Mark as generated for this month
                        };
                        await db.from('recurring_transactions').insert([rulePayload]);
                        await loadRecurring();
                        showStatus("Transaksi & Aturan Berulang disimpan");
                    }
                    transactionForm.reset();
                    document.getElementById('date').valueAsDate = new Date();
                }
                await loadTransactions();
                renderDashboard();
            } catch(err) { alert("Error: " + err.message); }
            finally { btnSaveTx.disabled = false; if(!id) btnSaveTx.textContent = "Simpan"; }
        });

        document.getElementById('type').addEventListener('change', updateCategoryOptions);
        btnCancelEdit.addEventListener('click', window.cancelEdit);

        document.getElementById('delete-modal-confirm').addEventListener('click', async () => {
            if(!deleteTarget) return;
            const { type, id } = deleteTarget;
            
            if (type === 'transaction') {
                await db.from('transactions').delete().eq('id', id);
                await loadTransactions();
                renderDashboard();
            } else if (type === 'category') {
                await db.from('categories').delete().eq('id', id);
                await loadCategories();
            } else if (type === 'recurring') {
                await db.from('recurring_transactions').delete().eq('id', id);
                await loadRecurring();
            }
            
            hideModal('delete-modal');
            showStatus("Data dihapus.");
            deleteTarget = null;
        });

        document.querySelectorAll('#delete-modal-cancel').forEach(b => b.addEventListener('click', () => hideModal('delete-modal')));
        document.getElementById('category-modal-form').addEventListener('submit', async e => {
            e.preventDefault();
            const name = document.getElementById('category-modal-name').value;
            const type = document.getElementById('category-modal-type').value;
            const id = document.getElementById('category-modal-id').value;
            
            if(id) await db.from('categories').update({name, type}).eq('id', id);
            else await db.from('categories').insert([{name, type, user_id: userId}]);
            
            hideModal('category-modal');
            await loadCategories();
        });
        document.getElementById('category-modal-cancel').addEventListener('click', () => hideModal('category-modal'));
        
        // Navigasi
        document.querySelectorAll('.nav-link').forEach(l => l.addEventListener('click', e => { 
            e.preventDefault(); 
            document.querySelectorAll('.view-content').forEach(v => v.classList.add('hidden')); 
            document.getElementById(l.dataset.view).classList.remove('hidden'); 
            if (l.dataset.view === 'view-laporan-bulanan') {
                // Trigger render report logic (simplified here, ensure loadTransactions called)
                // In full code, call renderMonthlyReport()
            }
        }));

        // Init Date
        document.getElementById('date').valueAsDate = new Date();
    </script>
</body>
</html>
